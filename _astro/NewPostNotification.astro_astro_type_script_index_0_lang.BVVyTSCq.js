import{D as j}from"./base.CrPFMexR.js";class U extends j{constructor(){super(...arguments),this.tokenize=R}equals(g,o,l){return l.ignoreWhitespace?((!l.newlineIsToken||!g.includes(`
`))&&(g=g.trim()),(!l.newlineIsToken||!o.includes(`
`))&&(o=o.trim())):l.ignoreNewlineAtEof&&!l.newlineIsToken&&(g.endsWith(`
`)&&(g=g.slice(0,-1)),o.endsWith(`
`)&&(o=o.slice(0,-1))),super.equals(g,o,l)}}const z=new U;function F(x,g,o){return z.diff(x,g,o)}function R(x,g){g.stripTrailingCr&&(x=x.replace(/\r\n/g,`
`));const o=[],l=x.split(/(\n|\r\n)/);l[l.length-1]||l.pop();for(let b=0;b<l.length;b++){const A=l[b];b%2&&!g.newlineIsToken?o[o.length-1]+=A:o.push(A)}return o}(async function(){const x="fuwari-rss-store",o="posts",l="blog-posts-cache",b="new-post-list",_="/".replace(/^\/+|\/+$/g,"")||"root";function $(){return new Promise((s,u)=>{const n=indexedDB.open(x,3);n.onerror=()=>u(n.error),n.onsuccess=()=>s(n.result),n.onupgradeneeded=r=>{const i=r.target.result;if(i.objectStoreNames.contains(o)){r.target.transaction.objectStore(o).keyPath!=="id"&&(i.deleteObjectStore(o),i.createObjectStore(o,{keyPath:"id"}));return}i.createObjectStore(o,{keyPath:"id"})}})}function O(s,u){const n=(s||u||"").trim();if(!n)return"";try{const r=new URL(n,window.location.origin);return`${r.pathname}${r.search}${r.hash}`}catch{return n}}function C(s){return`${_}:${s}`}function q(s){return new Promise((u,n)=>{const e=s.transaction([o],"readonly").objectStore(o).getAll();e.onsuccess=()=>u(e.result),e.onerror=()=>n(e.error)})}function N(s,u){return new Promise((n,r)=>{const i=s.transaction([o],"readwrite"),e=i.objectStore(o);u.forEach(f=>{const a={...f,id:C(f.guid)};e.put(a)}),i.oncomplete=()=>n(),i.onerror=()=>r(i.error)})}async function M(){try{const u=await(await fetch("/rss.xml",{cache:"no-store"})).text(),r=new DOMParser().parseFromString(u,"text/xml");return Array.from(r.querySelectorAll("item")).map(e=>{const f=e.querySelector("title")?.textContent||"",a=(e.querySelector("link")?.textContent||"").trim(),m=(e.querySelector("guid")?.textContent||"").trim(),S=O(m||a,a),k=new Date(e.querySelector("pubDate")?.textContent||"").getTime(),p=e.querySelector("description")?.textContent||"",c=e.getElementsByTagNameNS("http://purl.org/rss/1.0/modules/content/","encoded")[0]?.textContent||e.getElementsByTagName("content:encoded")[0]?.textContent||e.querySelector("content")?.textContent||"";return{title:f,link:a,guid:S,pubDate:k,description:p,content:c}})}catch(s){return console.error("Failed to fetch RSS:",s),[]}}function B(s,u){if(!s||!u)return null;const n=a=>{const m=document.createElement("DIV");return m.innerHTML=a,m.textContent||m.innerText||""},r=n(s),i=n(u),e=F(r,i);return e.some(a=>a.added||a.removed)?e:null}function w(s,u,n,r){const i=document.getElementById("notification-minimized"),e=document.getElementById("notification-panel"),f=document.getElementById(b),a=document.getElementById("notification-dot"),m=document.getElementById("minimize-notification"),S=document.getElementById("clear-notification"),k="fuwari-notification-state",p="fuwari-notification-init-time";if(!i||!e||!f)return;requestAnimationFrame(()=>{i.classList.remove("translate-y-20","opacity-0")});const t=new Date(r).toLocaleString(),c=new Date(u).toLocaleString();if(s.length===0){f.innerHTML=`<div class="text-center text-gray-500 dark:text-gray-400 py-4">
                <p class="text-sm font-medium mb-2">暂无文章更新</p>
                <div class="text-xs opacity-70 bg-gray-100 dark:bg-gray-800 rounded px-2 py-1 inline-block">
                    ${t} - ${c}
                </div>
             </div>`,a?.classList.add("hidden"),L();return}let T=`
            <div class="text-xs text-gray-500 dark:text-gray-400 mb-2 px-1 flex flex-col gap-0.5">
                <div class="font-medium">发现更新</div>
                <div class="opacity-70 text-[10px]">${t} - ${c}</div>
            </div>`;s.forEach(d=>{const h=d.isUpdated,v=h?'<span class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 px-1.5 py-0.5 rounded ml-2">更新</span>':'<span class="text-xs bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-300 px-1.5 py-0.5 rounded ml-2">新文章</span>';let y="";const P="diff-"+d.guid.replace(/[^a-zA-Z0-9-_]/g,"_");h&&d.diff&&(y=`
                <button onclick="window.toggleDiff('${P}')" class="ml-auto text-xs text-[var(--primary)] hover:underline focus:outline-none pointer-events-auto">
                    查看变更
                </button>`),T+=`
            <div class="mb-2 last:mb-0">
                <div class="flex items-center justify-between p-2 rounded-lg hover:bg-[var(--primary)]/5 transition-colors">
                    <a href="${d.link}" class="font-medium truncate pr-2 hover:text-[var(--primary)] transition-colors text-black dark:text-white block flex-1" target="_blank">
                        ${d.title}
                    </a>
                    <div class="flex items-center shrink-0">
                        ${y}
                        ${v}
                    </div>
                </div>
                ${h&&d.diff?`
                <div id="${P}" class="hidden mt-2 p-2 bg-gray-50 dark:bg-gray-800 rounded text-xs overflow-x-auto border border-gray-200 dark:border-gray-700 max-h-60 overflow-y-auto">
                    ${d.diff.map(I=>`<div class="${I.added?"bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 block my-1 p-1 rounded break-all whitespace-pre-wrap":I.removed?"bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 block my-1 p-1 rounded break-all whitespace-pre-wrap":"text-gray-500 dark:text-gray-400 block my-1 p-1 break-all whitespace-pre-wrap"}">${I.value}</div>`).join("")}
                </div>
                `:""}
            </div>`}),f.innerHTML=T,n?(a?.classList.remove("hidden"),setTimeout(()=>{D()},1500)):a?.classList.add("hidden"),L();function L(){const d=()=>{e.classList.remove("hidden"),requestAnimationFrame(()=>{e.classList.remove("translate-y-4","opacity-0","scale-95")}),a?.classList.add("hidden")},h=()=>{e.classList.add("translate-y-4","opacity-0","scale-95"),setTimeout(()=>{e.classList.add("hidden")},300)};i.onclick=()=>{e.classList.contains("hidden")?d():h()},m.onclick=v=>{v.stopPropagation(),h(),setTimeout(()=>{i.classList.add("translate-y-20","opacity-0"),i.classList.add("pointer-events-none")},300)},S&&(S.onclick=v=>{v.stopPropagation(),localStorage.removeItem(k);const y=Date.now();localStorage.setItem(p,y.toString()),w([],y,!1,y)}),f.hasAttribute("data-listening")||(f.addEventListener("click",v=>{const y=v.target.closest("[data-diff-toggle]");if(y){const P=y.getAttribute("data-diff-toggle"),I=document.getElementById(P);I&&I.classList.toggle("hidden")}}),f.setAttribute("data-listening","true"))}function D(){e.classList.remove("hidden"),requestAnimationFrame(()=>{e.classList.remove("translate-y-4","opacity-0","scale-95")}),a?.classList.add("hidden")}const E=()=>{e.classList.add("translate-y-4","opacity-0","scale-95"),setTimeout(()=>{e.classList.add("hidden")},300)};i.onclick=()=>{e.classList.contains("hidden")?D():E()},m.onclick=d=>{d.stopPropagation(),E()},window.toggleDiff=function(d){const h=document.getElementById(d);h&&h.classList.toggle("hidden")}}try{if(new URLSearchParams(window.location.search).has("debug-notification")){console.log("[Notification] Developer mode active"),w([{title:"Test New Post 1",link:"#",guid:"test-1",isUpdated:!1},{title:"Test Updated Post",link:"#",guid:"test-2",isUpdated:!0,diff:[{value:`This is some unchanged text context.
`,added:void 0,removed:void 0},{value:`This line was removed.
`,added:void 0,removed:!0},{value:`This line is new.
`,added:!0,removed:void 0},{value:`More unchanged text.
`,added:void 0,removed:void 0}]}],Date.now(),!0,Date.now());return}const n=await M();if(n.length===0)return;const r=await $(),i=await q(r),e="fuwari-notification-state",f="fuwari-notification-init-time";let a=localStorage.getItem(f);a||(a=Date.now().toString(),localStorage.setItem(f,a));const m=parseInt(a),S=localStorage.getItem(l);if(i.length===0&&S){console.log("[Notification] Migrating from localStorage..."),await N(r,n),localStorage.removeItem(l),w([],Date.now(),!1,m);return}if(i.length===0)await N(r,n),localStorage.removeItem(e),w([],Date.now(),!1,m);else{const k=new Map(i.map(t=>[t.id||C(t.guid||t.link||t.title),t])),p=[];if(n.forEach(t=>{const c=k.get(C(t.guid));if(!c)p.push({...t,isUpdated:!1});else{const T=t.title!==c.title,L=t.pubDate!==c.pubDate,D=t.description!==c.description,E=t.content!==c.content;if(T||L||D||E){let d=null;E?d=B(c.content,t.content):D?d=B(c.description,t.description):T&&(d=B(c.title,t.title)),p.push({...t,isUpdated:!0,diff:d})}}}),p.length>0){const t=Date.now(),c={timestamp:t,items:p};localStorage.setItem(e,JSON.stringify(c)),await N(r,n),w(p,t,!0,m)}else{const t=localStorage.getItem(e);if(t)try{const c=JSON.parse(t);w(c.items,c.timestamp,!1,m)}catch(c){console.error("Failed to parse notification state",c),w([],Date.now(),!1,m)}else w([],Date.now(),!1,m)}}}catch(s){console.error("New post check failed:",s)}})();
